/*  This file is part of Imagine.

	Imagine is free software: you can redistribute it and/or modify
	it under the terms of the GNU General Public License as published by
	the Free Software Foundation, either version 3 of the License, or
	(at your option) any later version.

	Imagine is distributed in the hope that it will be useful,
	but WITHOUT ANY WARRANTY; without even the implied warranty of
	MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
	GNU General Public License for more details.

	You should have received a copy of the GNU General Public License
	along with Imagine.  If not, see <http://www.gnu.org/licenses/> */

export module tests;
import imagine;
import std;

export namespace tests
{

using namespace IG;

enum class TestID
{
	Clear,
	Draw,
	Write,
};

struct FramePresentTime
{
	IG::SteadyClockTimePoint time{};
	IG::SteadyClockTimePoint atOnFrame{};
	IG::SteadyClockTimePoint atWinPresent{};
};

struct TestParams
{
	TestID test{};
	IG::WSize pixmapSize{};
	IG::Gfx::TextureBufferMode bufferMode{};
};

struct TestDesc
{
	TestParams params;
	std::string name;

	constexpr TestDesc(TestID test, std::string name, IG::WSize pixmapSize = {},
		IG::Gfx::TextureBufferMode bufferMode = {})
		: params{test, pixmapSize, bufferMode}, name{name} {}
};

class TestFramework
{
public:
	using TestFinishedDelegate = DelegateFunc<void (TestFramework&)>;
	bool started{};
	bool shouldEndTest{};
	unsigned frames{};
	unsigned droppedFrames{};
	unsigned continuousFrames{};
	IG::SteadyClockTimePoint presentTime{};
	IG::SteadyClockTimePoint startTime{}, endTime{};
	TestFinishedDelegate onTestFinished;
	FramePresentTime lastFramePresentTime;
	IG::Gfx::IQuads statsRectQuads;

	TestFramework(IG::ViewAttachParams attach);
	virtual ~TestFramework() = default;
	virtual void placeTest(IG::WRect) {}
	virtual void frameUpdateTest(IG::Gfx::RendererTask&, IG::Screen&, IG::SteadyClockTimePoint) = 0;
	virtual void drawTest(IG::Gfx::RendererCommands&, IG::Gfx::ClipRect bounds) = 0;
	virtual void presentedTest(IG::Gfx::RendererCommands&) {}
	void place(IG::WRect viewBounds_, IG::WRect testRect);
	void frameUpdate(IG::Gfx::RendererTask& rTask, IG::Window& win, IG::FrameParams frameParams);
	void prepareDraw();
	void draw(IG::Gfx::RendererCommands& cmds, IG::Gfx::ClipRect bounds, int xIndent);
	void finish(IG::SteadyClockTimePoint frameTime);
	void setCPUFreqText(std::string_view str);
	void setCPUUseText(std::string_view str);

protected:
	IG::Gfx::Text cpuStatsText;
	IG::Gfx::Text frameStatsText;
	std::string cpuFreqStr;
	std::string cpuUseStr;
	std::string skippedFrameStr;
	std::string statsStr;
	IG::WRect viewBounds{};
	IG::WRect cpuStatsRect{};
	IG::WRect frameStatsRect{};
	Milliseconds lostFrameProcessTime{};

	void placeCPUStatsText();
	void placeFrameStatsText();
};

class ClearTest : public TestFramework
{
protected:
	bool flash{true};

public:
	using TestFramework::TestFramework;
	void frameUpdateTest(IG::Gfx::RendererTask&, IG::Screen&, IG::SteadyClockTimePoint) override;
	void drawTest(IG::Gfx::RendererCommands& cmds, IG::Gfx::ClipRect) override;
};

class DrawTest : public TestFramework
{
protected:
	int flash{true};
	IG::Gfx::ITexQuads quad;
	IG::Gfx::PixmapBufferTexture texture;

public:
	DrawTest(IG::ApplicationContext ctx, IG::ViewAttachParams attach, IG::WSize pixmapSize, IG::Gfx::TextureBufferMode bufferMode);
	void drawTest(IG::Gfx::RendererCommands& cmds, IG::Gfx::ClipRect bounds) override;
	void placeTest(IG::WRect rect) override;
	void frameUpdateTest(IG::Gfx::RendererTask&, IG::Screen&, IG::SteadyClockTimePoint) override;
};

class WriteTest : public DrawTest
{
public:
	using DrawTest::DrawTest;
	void frameUpdateTest(IG::Gfx::RendererTask& rendererTask, IG::Screen& screen, IG::SteadyClockTimePoint frameTime) override;
	void drawTest(IG::Gfx::RendererCommands& cmds, IG::Gfx::ClipRect bounds) override;
};

}
